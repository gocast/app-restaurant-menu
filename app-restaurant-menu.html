<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../goc-styles/goc-styles.html">
<link rel="import" href="../goc-icons/goc-icons.html">
<link rel="import" href="../goc-apps/goc-app-icon.html">
<link rel="import" href="app-restaurant-new-category-overlay.html">
<link rel="import" href="app-restaurant-new-item-overlay.html">

<dom-module id="app-restaurant-menu">
  <template>
    <style include="header-layout-styles box-styles btn-styles icon-btn-styles">
      :host {
        background: var(--goc-background-color);
        display: block;
        height: 100%;
      }

      .box {
        margin-bottom: 20px;
      }
    </style>

    <goc-apps-collection
        app-name="restaurant-menu"
        item="{{_appInfo}}"
        language="[[language]]"></goc-apps-collection>

    <div class="header-layout">
      <div class="header-layout__header">
        <div class="header-toolbar">

          <button class="icon-btn icon-btn--primary" on-click="_onBackTapped">
            <touch-item><iron-icon icon="arrow-back"></iron-icon></touch-item>
          </button>

          <goc-app-icon size="small" app-name="restaurant-menu"></goc-app-icon>

          <div class="header-toolbar__main-content">
            <div class="header-toolbar__title">[[contentName]]</div>
            <div class="header-toolbar__subtitle">[[_appInfo.displayName]]</div>
          </div>

        </div>
      </div>

      <div class="header-layout__content">
        <dom-repeat items="[[data.categories]]" as="category">
          <template>
            <div class="box">
              <div class="box__row">[[category.name]]</div>
              <div class="box__row">
                <button on-click="_onAddItemTapped">
                  <touch-item>
                    <iron-icon icon="plus"></iron-icon>
                    Add item
                  </touch-item>
                </button>
              </div>
              <dom-repeat items="[[category.items]]">
                <template>
                  <div class="box__row" on-click="_onEditItemTapped">
                    <div>[[item.name]]</div>
                  </div>
                </template>
              </dom-repeat>
            </div>
          </template>
        </dom-repeat>

        <button on-click="_onCreateCategoryTapped">Create Category</button>
      </div>
    </div>

  </template>
  <script>

    class AppRestaurantMenu extends Polymer.Element {

      static get is() {return 'app-restaurant-menu';}

      static get properties() {
        return {

          contentName: String,

          data: {
            type: Object,
            observer: '_dataChanged'
          },

          _appInfo: Object,

          _newCategoryOverlay: Object

        };
      }

      _dataChanged(data) {
        if (data === null) {
          this.data = {categories: []};
        }
      }

      _onCreateCategoryTapped(event) {
        if (!this._newCategoryOverlay) {
          this._newCategoryOverlay = document.createElement('app-restaurant-new-category-overlay');

          this._newCategoryOverlay.onDetach = _ => {
            this._newCategoryOverlay = null;
          };

          this._newCategoryOverlay.addEventListener('submit', event => {
            if (!event.currentTarget.canceled) {
              this.push('data.categories', event.detail);
            }
          });

          this._newCategoryOverlay.open();
        }
      }

      _onAddItemTapped(event) {
        if (!this._newItemOverlay) {
          const category = event.model.category;
          const categoryIndex = this.data.categories.indexOf(category);

          if (!category.items) {
            this.set(`data.categories.${categoryIndex}.items`, []);
          }

          this._newItemOverlay = document.createElement('app-restaurant-new-item-overlay');
          this._newItemOverlay.onDetach = _ => {
            this._newItemOverlay = null;
          };

          this._newItemOverlay.addEventListener('submit', event => {
            if (!event.currentTarget.canceled) {
              this.push(`data.categories.${categoryIndex}.items`, event.detail);
              console.log(this.data.categories)
            }
          });

          this._newItemOverlay.open();
        }
      }

      _onEditItemTapped(event) {
        if (!this._newItemOverlay) {
          const item = event.model.item;

          this._newItemOverlay = document.createElement('app-restaurant-new-item-overlay');
          this._newItemOverlay.onDetach = _ => {
            this._newItemOverlay = null;
          };

          this._newItemOverlay.item = item;

          this._newItemOverlay.addEventListener('submit', event => {
            if (!event.currentTarget.canceled) {
              // update the item!
            }
          });

          this._newItemOverlay.addEventListener('delete', event => {
            // delete the item
          });

          this._newItemOverlay.open();
        }
      }

    }

    customElements.define(AppRestaurantMenu.is, AppRestaurantMenu);

    // {
    //   categories: [
    //     {name: 'Entrantes', items: [{name: 'patatas', price: '6â‚¬'}]}
    //   ]
    // }

  </script>
</dom-module>
